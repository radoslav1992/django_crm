{% extends "base.html" %}
{% load i18n static %}

{% block title %}{% trans "AI Template Studio" %} - CRM{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1><i class="bi bi-robot"></i> {% trans "AI Template Studio" %}</h1>
        <p class="text-muted">{% trans "Create professional invoice and offer templates using AI - just describe what you want!" %}</p>
    </div>
    <div class="col-md-4 text-end">
        <a href="{% url 'templates:template_list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-list"></i> {% trans "View Templates" %}
        </a>
    </div>
</div>

<div class="row">
    <!-- AI Template Generator -->
    <div class="col-lg-6 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-magic"></i> {% trans "AI Template Generator" %}</h5>
            </div>
            <div class="card-body">
                <!-- Template Type Selection -->
                <div class="mb-3">
                    <label for="template_type" class="form-label">{% trans "Template Type" %}</label>
                    <select class="form-select" id="template_type">
                        <option value="invoice">{% trans "Invoice" %}</option>
                        <option value="offer">{% trans "Offer" %}</option>
                    </select>
                        </div>

                <!-- AI Prompt -->
                <div class="mb-3">
                    <label for="ai_prompt" class="form-label">{% trans "Describe your template" %}</label>
                    <textarea 
                        class="form-control" 
                        id="ai_prompt" 
                        rows="6" 
                        maxlength="2000"
                        oninput="updateCharCount()"
                        placeholder="{% trans 'Example: Create a modern invoice template with a blue header, company logo on the left, clean table for items, and a footer with payment terms. Use a professional font and make it print-friendly.' %}"></textarea>
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">
                            {% trans "Be specific about colors, layout, style, and any special requirements." %}
                        </small>
                        <small class="text-muted" id="char_count">0/2000</small>
                    </div>
                </div>

                <!-- Generate Button -->
                <div class="d-grid">
                    <button class="btn btn-primary btn-lg" id="generate_btn" onclick="generateTemplate()">
                        <i class="bi bi-magic"></i> {% trans "Generate Template" %}
                    </button>
                    </div>

                <!-- Loading Indicator -->
                <div id="loading_indicator" class="text-center mt-3" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">{% trans "Loading..." %}</span>
                    </div>
                    <p class="mt-2">{% trans "AI is creating your template..." %}</p>
                </div>

                <!-- Suggestions -->
                <div class="mt-4">
                    <h6>{% trans "Quick Ideas:" %}</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="setPrompt('Create a minimalist invoice template with a black and white color scheme')">
                            {% trans "Minimalist B&W" %}
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="setPrompt('Create a colorful and modern offer template with gradient headers')">
                            {% trans "Modern Gradient" %}
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="setPrompt('Create a professional invoice with sidebar for company info')">
                            {% trans "Sidebar Layout" %}
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="setPrompt('Create an elegant invoice template with serif fonts and gold accents')">
                            {% trans "Elegant Gold" %}
                        </button>
                    </div>
                </div>

                <!-- Refine Section -->
                <div id="refine_section" class="mt-4" style="display: none;">
                    <hr>
                    <h6>{% trans "Refine Template" %}</h6>
                    <div class="input-group">
                        <input 
                            type="text" 
                            class="form-control" 
                            id="refine_prompt" 
                            placeholder="{% trans 'Example: Make the header smaller, change color to green, add more spacing...' %}">
                        <button class="btn btn-outline-primary" onclick="refineTemplate()">
                            <i class="bi bi-arrow-clockwise"></i> {% trans "Refine" %}
                        </button>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Preview and Save -->
    <div class="col-lg-6 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-eye"></i> {% trans "Preview" %}</h5>
                <button class="btn btn-sm btn-light" id="save_btn" onclick="showSaveModal()" style="display: none;">
                    <i class="bi bi-save"></i> {% trans "Save Template" %}
                </button>
            </div>
            <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                <div id="template_preview" class="border rounded p-3 bg-light" style="min-height: 400px;">
                    <div class="text-center text-muted mt-5">
                        <i class="bi bi-file-earmark-text" style="font-size: 4rem;"></i>
                        <p class="mt-3">{% trans "Your AI-generated template will appear here" %}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Available Variables Reference -->
<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-code-slash"></i> {% trans "Available Template Variables" %}</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">{% trans "The AI will automatically use these variables in your template:" %}</p>
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li><code>{{invoice_number}}</code> or <code>{{offer_number}}</code> - {% trans "Document number" %}</li>
                            <li><code>{{invoice_date}}</code> or <code>{{offer_date}}</code> - {% trans "Document date" %}</li>
                            <li><code>{{due_date}}</code> - {% trans "Due date" %}</li>
                            <li><code>{{client_name}}</code> - {% trans "Client name" %}</li>
                            <li><code>{{client_address}}</code> - {% trans "Client address" %}</li>
                            <li><code>{{client_email}}</code> - {% trans "Client email" %}</li>
                            <li><code>{{company_name}}</code> - {% trans "Your company name" %}</li>
                            <li><code>{{company_address}}</code> - {% trans "Your company address" %}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-unstyled">
                            <li><code>{{logo_url}}</code> - {% trans "Company logo" %}</li>
                            <li><code>{{items}}</code> - {% trans "Line items (table)" %}</li>
                            <li><code>{{subtotal}}</code> - {% trans "Subtotal" %}</li>
                            <li><code>{{tax_amount}}</code> - {% trans "Tax amount" %}</li>
                            <li><code>{{total}}</code> - {% trans "Grand total" %}</li>
                            <li><code>{{notes}}</code> - {% trans "Additional notes" %}</li>
                            <li><code>{{payment_terms}}</code> - {% trans "Payment terms" %}</li>
                            <li><code>{{bank_details}}</code> - {% trans "Bank details" %}</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Save Template Modal -->
<div class="modal fade" id="saveTemplateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "Save Template" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="template_name" class="form-label">{% trans "Template Name" %}</label>
                    <input type="text" class="form-control" id="template_name" required>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="set_as_default">
                    <label class="form-check-label" for="set_as_default">
                        {% trans "Set as default template" %}
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                <button type="button" class="btn btn-primary" onclick="saveTemplate()">
                    <i class="bi bi-save"></i> {% trans "Save" %}
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentTemplateHTML = '';
    let currentTemplateType = 'invoice';

    function setPrompt(text) {
        document.getElementById('ai_prompt').value = text;
        updateCharCount();
    }
    
    function updateCharCount() {
        const textarea = document.getElementById('ai_prompt');
        const charCount = document.getElementById('char_count');
        const count = textarea.value.length;
        charCount.textContent = count + '/2000';
        
        if (count > 1800) {
            charCount.classList.add('text-warning');
        } else {
            charCount.classList.remove('text-warning');
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    async function generateTemplate() {
        const prompt = document.getElementById('ai_prompt').value.trim();
        const templateType = document.getElementById('template_type').value;
        
        if (!prompt) {
            alert('{% trans "Please describe your template" %}');
            return;
        }

        currentTemplateType = templateType;

        // Show loading
        document.getElementById('loading_indicator').style.display = 'block';
        document.getElementById('generate_btn').disabled = true;
        
        try {
            const response = await fetch('{% url "templates:generate_ai_template" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    prompt: prompt,
                    template_type: templateType
                })
            });

            const data = await response.json();
            
            if (data.success) {
                currentTemplateHTML = data.html_content;
                document.getElementById('template_preview').innerHTML = data.html_content;
                document.getElementById('refine_section').style.display = 'block';
                document.getElementById('save_btn').style.display = 'block';
                
                // Show success message with remaining requests
                let message = data.message || '{% trans "Template generated successfully!" %}';
                if (data.ai_requests_remaining !== undefined && data.ai_requests_remaining >= 0) {
                    message += ` (${data.ai_requests_remaining} {% trans "AI requests remaining this month" %})`;
                }
                showAlert(message, 'success');
            } else {
                showAlert(data.error || '{% trans "Failed to generate template" %}', 'danger');
                
                // If upgrade required, show upgrade button
                if (data.upgrade_required) {
                    setTimeout(() => {
                        if (confirm('{% trans "You have reached your AI limit. Would you like to upgrade your plan?" %}')) {
                            window.location.href = '{% url "subscriptions:plans" %}';
                        }
                    }, 500);
                }
            }
        } catch (error) {
            showAlert('{% trans "Error communicating with AI" %}', 'danger');
            console.error(error);
        } finally {
            document.getElementById('loading_indicator').style.display = 'none';
            document.getElementById('generate_btn').disabled = false;
        }
    }

    async function refineTemplate() {
        const feedback = document.getElementById('refine_prompt').value.trim();
        
        if (!feedback || !currentTemplateHTML) {
            alert('{% trans "Please provide refinement instructions" %}');
            return;
        }

        // Show loading
        document.getElementById('loading_indicator').style.display = 'block';
        
        try {
            const response = await fetch('{% url "templates:refine_ai_template" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    current_html: currentTemplateHTML,
                    feedback: feedback
                })
            });

            const data = await response.json();
            
            if (data.success) {
                currentTemplateHTML = data.html_content;
                document.getElementById('template_preview').innerHTML = data.html_content;
                document.getElementById('refine_prompt').value = '';
                showAlert(data.message || '{% trans "Template refined successfully!" %}', 'success');
            } else {
                showAlert(data.error || '{% trans "Failed to refine template" %}', 'danger');
            }
        } catch (error) {
            showAlert('{% trans "Error communicating with AI" %}', 'danger');
            console.error(error);
        } finally {
            document.getElementById('loading_indicator').style.display = 'none';
        }
    }

    function showSaveModal() {
        const modal = new bootstrap.Modal(document.getElementById('saveTemplateModal'));
        modal.show();
    }

    async function saveTemplate() {
        const templateName = document.getElementById('template_name').value.trim();
        const isDefault = document.getElementById('set_as_default').checked;
        
        if (!templateName || !currentTemplateHTML) {
            alert('{% trans "Please provide a template name" %}');
            return;
        }

        try {
            const response = await fetch('{% url "templates:save_ai_template" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    name: templateName,
                    template_type: currentTemplateType,
                    html_content: currentTemplateHTML,
                    is_default: isDefault
                })
            });

            const data = await response.json();
            
            if (data.success) {
                showAlert(data.message || '{% trans "Template saved successfully!" %}', 'success');
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('saveTemplateModal'));
                modal.hide();
                
                // Redirect to template detail after a short delay
                setTimeout(() => {
                    window.location.href = data.redirect_url;
                }, 1500);
            } else {
                showAlert(data.error || '{% trans "Failed to save template" %}', 'danger');
            }
        } catch (error) {
            showAlert('{% trans "Error saving template" %}', 'danger');
            console.error(error);
        }
    }

    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
        alertDiv.style.zIndex = '9999';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }
</script>

<style>
    #template_preview {
        background: white;
    }
    
    #template_preview iframe {
        border: none;
        width: 100%;
        min-height: 400px;
    }
</style>
{% endblock %}
